<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClassBuddy - Offline Schedule</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');
:root {
--bg-main: #f5f5f7;
--bg-card: #ffffff;
--bg-alt: #e5e5ea;
--text-primary: #1d1d1f;
--text-secondary: #86868b;
--accent-primary: #007AFF;
--accent-rgb: 0, 122, 255;
--accent-primary-hover: #0062CC;
--text-on-accent: #ffffff;
--border-color: #d1d1d6;
--bg-badge: #eef2ff;
--text-badge: #4338ca;
--timeline-indicator: #dc2626; /* Red for high visibility */
}
.dark {
--bg-main: #000000;
--bg-card: #1c1c1e;
--bg-alt: #2c2c2e;
--text-primary: #ffffff;
--text-secondary: #8e8e93;
--accent-primary: #0A84FF;
--accent-rgb: 10, 132, 255;
--accent-primary-hover: #3395FF;
--text-on-accent: #ffffff;
--border-color: #38383a;
--bg-badge: #4338ca;
--text-badge: #eef2ff;
--timeline-indicator: #ef4444;
}
body {
font-family: -apple-system, BlinkMacSystemFont, "Sarabun", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
background-color: var(--bg-main);
color: var(--text-primary);
transition: background-color 0.3s ease, color 0.3s ease;
}
.schedule-card, .bg-card, .bg-alt, .toggle-bg, .badge, #question-input, button, .suggestion-pill {
transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}
.schedule-card {
background-color: var(--bg-card);
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease;
}
.schedule-card:hover {
transform: translateY(-3px);
box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
}
#chat-container {
scroll-behavior: smooth;
}
.chat-bubble {
animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}
/* Custom styles for new palette */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.bg-accent { background-color: var(--accent-primary); }
.hover\:bg-accent-hover:hover { background-color: var(--accent-primary-hover); }
.text-on-accent { color: var(--text-on-accent); }
.border-default { border-color: var(--border-color); }
.ring-accent:focus { --tw-ring-color: var(--accent-primary); }
.bg-alt { background-color: var(--bg-alt); }
#question-input::placeholder { color: var(--text-secondary); }
.badge { background-color: var(--bg-badge); color: var(--text-badge); }
/* Toggle Switch Styles */
    .toggle-bg {
         background-color: var(--bg-alt);
         transition: background-color 0.2s ease;
    }
    .toggle-dot {
        transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    input:checked ~ .toggle-bg {
        background-color: var(--accent-primary);
    }
    input:checked + .toggle-bg { /* Direct sibling for editor toggles */
         background-color: var(--accent-primary);
    }
    input:checked + .toggle-bg + .toggle-dot {
         transform: translateX(1.25rem); /* 20px */
    }

    /* Suggestion Pill Styles */
    .suggestion-pill {
        background-color: var(--bg-alt);
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.4rem 0.9rem;
        border-radius: 9999px;
        border: none;
        cursor: pointer;
    }
    .suggestion-pill:hover {
        background-color: var(--accent-primary);
        color: var(--text-on-accent);
    }
    
    /* View Toggle Styles */
    .view-toggle-btn { padding: 0.25rem 1rem; border-radius: 9999px; border: 2px solid transparent; outline: none; transition: all 0.2s ease-in-out; }
    .view-toggle-btn.active { background-color: var(--accent-primary); color: var(--text-on-accent); }
    .view-toggle-btn:not(.active) { color: var(--text-secondary); }
    .view-toggle-btn:not(.active):hover { background-color: rgba(var(--accent-rgb), 0.1); }
    
    /* Timeline Styles */
    #timeline-view {
        background-color: var(--bg-card);
        border-radius: 1rem;
        padding: 1.5rem;
        overflow-x: auto;
        /* For better touch scrolling on mobile */
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
        position: relative;
    }
    /* Visual hint for horizontal scrolling */
    .scroll-hint-container.is-scrollable::after {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 50px;
        background: linear-gradient(to right, rgba(var(--bg-card-rgb), 0), var(--bg-card));
        pointer-events: none;
        transition: opacity 0.2s;
    }
    .dark .scroll-hint-container.is-scrollable::after {
        background: linear-gradient(to right, rgba(28, 28, 30, 0), rgb(28, 28, 30));
    }

    .timeline-container {
        position: relative;
        width: 100%;
        height: 140px; /* Slightly shorter for mobile */
    }
    .timeline-hours {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
        font-size: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .timeline-grid {
        position: absolute;
        top: 2rem;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: space-between;
    }
    .timeline-grid-line {
        width: 1px;
        background-color: rgba(var(--border-color-rgb, 209, 209, 214), 0.2);
    }
    .timeline-class-block {
        position: absolute;
        top: 2.5rem;
        height: 70px; /* Adjusted height */
        background-color: rgba(var(--accent-rgb), 0.9);
        color: var(--text-on-accent);
        border: 1px solid rgba(var(--accent-rgb), 1);
        border-radius: 0.5rem;
        padding: 0.5rem;
        font-size: 0.85rem; /* Slightly larger font for mobile */
        font-weight: 500;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
        animation: popIn 0.4s ease-out forwards;
    }
    @keyframes popIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
    .timeline-class-block:hover {
        transform: scale(1.02);
        z-index: 10;
    }
    .timeline-class-subject {
        font-weight: 700;
    }
    .timeline-time-indicator {
        position: absolute;
        top: 2rem;
        bottom: 0;
        width: 2px;
        background-color: var(--timeline-indicator);
        z-index: 20;
        transition: left 1s linear;
    }
    .timeline-time-indicator::before {
        content: '';
        position: absolute;
        top: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: var(--timeline-indicator);
    }

    /* --- MOBILE-FIRST EDIT FORM STYLES --- */
    .edit-class-row {
        display: grid;
        gap: 0.75rem; /* 12px */
        grid-template-areas:
            "time subject"
            "time controls";
        grid-template-columns: auto 1fr;
        align-items: center;
    }
    .edit-class-row-time { grid-area: time; display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }
    .edit-class-row-subject { grid-area: subject; }
    .edit-class-row-controls { grid-area: controls; display: flex; justify-content: space-between; align-items: center; }

    /* On larger screens, switch to a horizontal layout */
    @media (min-width: 640px) { /* Corresponds to sm: breakpoint */
        .edit-class-row {
            grid-template-areas: "time subject controls";
            grid-template-columns: auto 1fr auto;
            gap: 0.75rem;
        }
        .edit-class-row-time {
            flex-direction: row;
            gap: 0.5rem;
        }
        .edit-class-row-controls {
            gap: 1rem;
        }
    }
</style>
</head>
<body class="antialiased">
<div id="app" class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <header class="text-center mb-8 sm:mb-12">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-primary tracking-tight">ClassBuddy</h1>
        <p class="text-secondary mt-2 sm:mt-3 text-base sm:text-lg">Your intelligent class schedule assistant</p>
    </header>

    <main class="space-y-12">
        <!-- Q&A Section -->
        <section id="qa-section" aria-labelledby="qa-heading">
            <div class="bg-card rounded-2xl shadow-md p-4 sm:p-6">
                 <div class="flex justify-between items-center gap-y-3 mb-4 px-1">
                    <h2 id="qa-heading" class="text-lg font-bold text-primary">Chat with Buddy</h2>
                     <div class="flex items-center">
                         <button id="theme-toggle" type="button" class="p-2 rounded-full text-secondary hover:bg-alt focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent" aria-label="Toggle theme">
                             <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                             <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                         </button>
                     </div>
                </div>
                <div id="chat-container" class="h-64 overflow-y-auto mb-4 p-3 sm:p-4 bg-main rounded-xl">
                     <!-- Chat messages will be appended here -->
                </div>
                <form id="qa-form" class="flex items-center gap-2 sm:gap-3">
                    <input type="text" id="question-input" placeholder="e.g., â€œFirst class tomorrow?â€" class="flex-grow p-3 border border-default rounded-xl focus:ring-2 ring-accent focus:border-transparent transition w-full bg-alt placeholder:text-secondary" required autocomplete="off">
                    <button type="submit" class="bg-accent text-on-accent font-semibold py-3 px-4 sm:px-5 rounded-xl hover:bg-accent-hover transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 ring-accent flex-shrink-0">
                        Ask
                    </button>
                </form>
                <div id="chat-suggestions-container" class="flex flex-wrap items-center gap-2 mt-3 empty:mt-0">
                    <!-- Suggestion pills will be generated here -->
                </div>
            </div>
        </section>

        <!-- Schedule Section -->
        <section id="schedule-section" aria-labelledby="schedule-heading">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                <h2 id="schedule-heading" class="text-2xl sm:text-3xl font-extrabold text-primary tracking-tight">Schedule</h2>
                 <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div id="view-toggle-group" class="bg-alt p-1 rounded-full flex text-sm font-semibold flex-grow">
                        <button id="week-view-btn" class="view-toggle-btn active w-1/2">Week</button>
                        <button id="day-view-btn" class="view-toggle-btn w-1/2">Day</button>
                    </div>
                    <button id="edit-schedule-toggle" class="text-sm font-semibold py-2 px-4 rounded-lg border border-default text-secondary hover:bg-alt transition-colors sm:w-auto flex-shrink-0">
                        Edit
                    </button>
                </div>
            </div>

            <div id="schedule-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Schedule cards will be generated here -->
            </div>
            
            <div id="timeline-view" class="hidden scroll-hint-container">
                <!-- Timeline will be generated here -->
            </div>

            <div id="edit-schedule-form" class="hidden mt-8 p-4 sm:p-6 bg-card rounded-2xl border-default shadow-md">
                <h3 class="text-xl font-bold mb-2 text-primary">Edit Your Schedule</h3>
                <p class="text-sm text-secondary mb-6">Your schedule is saved automatically in your browser. It works 100% offline.</p>
                <div class="space-y-4" id="schedule-inputs">
                    <!-- Dynamic inputs for schedule editing will be generated here -->
                </div>
                 <button id="add-class-btn" class="w-full mt-6 bg-accent/10 text-accent font-semibold py-2 px-4 rounded-lg hover:bg-accent/20 transition-colors">
                    + Add Class
                </button>
            </div>
        </section>
    </main>
    
</div>

<footer class="text-center text-xs text-secondary mt-12 mb-6 space-y-1 px-4">
    <p>Â© <span id="current-year">2025</span> Wiqnnc_. All Rights Reserved.</p>
    <p>Made with love by Win.</p>
</footer>

<script type="module">
    // --- SERVICE WORKER FOR OFFLINE SUPPORT ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- TYPES ---
        
        // --- STATE & CONSTANTS ---
        const DAYS_OF_WEEK = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const ENG_TO_THAI_DAY_MAP = { 'Monday': 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ', 'Tuesday': 'à¸§à¸±à¸™à¸­à¸±à¸‡à¸„à¸²à¸£', 'Wednesday': 'à¸§à¸±à¸™à¸žà¸¸à¸˜', 'Thursday': 'à¸§à¸±à¸™à¸žà¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ', 'Friday': 'à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œ', 'Saturday': 'à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œ', 'Sunday': 'à¸§à¸±à¸™à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ' };
        const THAI_REGEX = /[\u0E00-\u0E7F]/;

        const DAY_KEYWORD_MAP = {
            'monday': 'Monday', 'mon': 'Monday', 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œ': 'Monday', 'à¸ˆà¸±à¸™à¸—à¸£à¹Œ': 'Monday',
            'tuesday': 'Tuesday', 'tue': 'Tuesday', 'tues': 'Tuesday', 'à¸§à¸±à¸™à¸­à¸±à¸‡à¸„à¸²à¸£': 'Tuesday', 'à¸­à¸±à¸‡à¸„à¸²à¸£': 'Tuesday',
            'wednesday': 'Wednesday', 'wed': 'Wednesday', 'à¸§à¸±à¸™à¸žà¸¸à¸˜': 'Wednesday', 'à¸žà¸¸à¸˜': 'Wednesday',
            'thursday': 'Thursday', 'thu': 'Thursday', 'thurs': 'Thursday', 'à¸§à¸±à¸™à¸žà¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ': 'Thursday', 'à¸žà¸¤à¸«à¸±à¸ª': 'Thursday',
            'friday': 'Friday', 'fri': 'Friday', 'à¸§à¸±à¸™à¸¨à¸¸à¸à¸£à¹Œ': 'Friday', 'à¸¨à¸¸à¸à¸£à¹Œ': 'Friday',
            'saturday': 'Saturday', 'sat': 'Saturday', 'à¸§à¸±à¸™à¹€à¸ªà¸²à¸£à¹Œ': 'Saturday', 'à¹€à¸ªà¸²à¸£à¹Œ': 'Saturday',
            'sunday': 'Sunday', 'sun': 'Sunday', 'à¸§à¸±à¸™à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ': 'Sunday', 'à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ': 'Sunday',
            'today': 'today', 'à¸§à¸±à¸™à¸™à¸µà¹‰': 'today',
            'tomorrow': 'tomorrow', 'à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰': 'tomorrow',
            'yesterday': 'yesterday', 'à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™': 'yesterday',
        };

        const TIME_CONTEXT_MAP = {
            'morning': { start: '00:00', end: '12:00', eng: 'morning', thai: 'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²' },
            'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²': { start: '00:00', end: '12:00', eng: 'morning', thai: 'à¸•à¸­à¸™à¹€à¸Šà¹‰à¸²' },
            'afternoon': { start: '12:00', end: '17:00', eng: 'afternoon', thai: 'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢' },
            'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢': { start: '12:00', end: '17:00', eng: 'afternoon', thai: 'à¸•à¸­à¸™à¸šà¹ˆà¸²à¸¢' },
            'evening': { start: '17:00', end: '24:00', eng: 'evening', thai: 'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™' },
            'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™': { start: '17:00', end: '24:00', eng: 'evening', thai: 'à¸•à¸­à¸™à¹€à¸¢à¹‡à¸™' },
        };
        
        // Expanded map for better bilingual and slang understanding
        const SUBJECT_KEYWORD_MAP = {
            // à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)
            'à¸›à¸£à¸°à¸§à¸±à¸•à¸´': 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)', 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ': 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)', 'history': 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)',

            // à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™
            'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡': 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™', 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™': 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™', 'à¸žà¸±à¸’à¸™à¸²': 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™',

            // à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7
            'à¸žà¸¥à¸°': 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7', 'pe': 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7', 'phys ed': 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7', 'physical education': 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7',

            // à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7
            'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²': 'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7', 'health': 'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7',

            // à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢
            'à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­': 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢', 'à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢': 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢', 'multimedia': 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢',

            // à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1
            'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡à¸žà¸¹à¸”': 'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1', 'listening speaking': 'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1',

            // à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7
            'à¸­à¸±à¸‡à¸à¸¤à¸©': 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7', 'eng': 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7', 'english': 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7',

            // à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)
            'à¸à¸²à¸£à¸‡à¸²à¸™': 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', 'à¸„à¸­à¸¡': 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', 'à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ': 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', 'computer': 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', 'à¸§à¸´à¸Šà¸²à¸„à¸­à¸¡': 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)',

            // à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7
            'à¸„à¸“à¸´à¸•': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7', 'math': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7', 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7',

            // à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1
            'à¸§à¸´à¸—à¸¢à¹Œ': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', 'science': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œ': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', 'physics': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', 'biology': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1', 'chemistry': 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1',

            // à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1
            'à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸': 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1', 'graphic design': 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1',

            // à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)
            'à¸¨à¸´à¸¥à¸›à¸°': 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', 'à¸”à¸™à¸•à¸£à¸µ': 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', 'art': 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', 'music': 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)',

            // à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)
            'à¸„à¸“à¸´à¸•à¹€à¸žà¸´à¹ˆà¸¡': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)', 'add math': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)', 'additional math': 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)',

            // à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹à¸¥à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆ
            'à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”': 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹à¸¥à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆ',

            // à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ
            'à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡': 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'programming': 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ', 'coding': 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ',

            // à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7
            'à¹„à¸—à¸¢': 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7', 'thai': 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7',

            // à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7
            'à¸ªà¸±à¸‡à¸„à¸¡': 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7', 'social studies': 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7',

            // Homeroom
            'homeroom': 'Homeroom', 'à¹‚à¸®à¸¡à¸£à¸¹à¸¡': 'Homeroom'
        };
        
        const REVERSE_SUBJECT_KEYWORD_MAP = Object.entries(SUBJECT_KEYWORD_MAP).reduce((acc, [keyword, subject]) => {
            if (!acc[subject]) {
                acc[subject] = { eng: [], thai: [] };
            }
            if (THAI_REGEX.test(keyword)) {
                acc[subject].thai.push(keyword);
            } else {
                acc[subject].eng.push(keyword);
            }
            return acc;
        }, {});

        const CHAT_SUGGESTIONS = [
            "What's my schedule today?",
            "à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™à¸§à¸±à¸™à¸™à¸µà¹‰",
            "What's my next class?",
            "à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£",
            "Do I have Math tomorrow?",
            "à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸„à¸“à¸´à¸•à¹„à¸«à¸¡",
            "Full weekly schedule",
            "à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™à¸—à¸±à¹‰à¸‡à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ",
            "When can I go home?",
            "à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹„à¸”à¹‰à¸•à¸­à¸™à¹„à¸«à¸™"
        ];
        
        let schedule = {};
        let currentView = 'week';
        let timeIndicatorInterval = null;


        // --- DOM ELEMENTS ---
        const qaForm = document.getElementById('qa-form');
        const questionInput = document.getElementById('question-input');
        const chatContainer = document.getElementById('chat-container');
        const chatSuggestionsContainer = document.getElementById('chat-suggestions-container');
        const scheduleGrid = document.getElementById('schedule-grid');
        const timelineView = document.getElementById('timeline-view');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const editScheduleToggleBtn = document.getElementById('edit-schedule-toggle');
        const editScheduleForm = document.getElementById('edit-schedule-form');
        const scheduleInputsContainer = document.getElementById('schedule-inputs');
        const addClassBtn = document.getElementById('add-class-btn');
        const weekViewBtn = document.getElementById('week-view-btn');
        const dayViewBtn = document.getElementById('day-view-btn');

        // --- THEME FUNCTIONS ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.add('hidden');
                themeToggleLightIcon.classList.remove('hidden');
            }
            // Update scroll hint for theme change
            if (currentView === 'day') {
                updateScrollHint();
            }
        };

        const toggleTheme = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const newTheme = isDarkMode ? 'light' : 'dark';
            localStorage.setItem('classBuddyTheme', newTheme);
            applyTheme(newTheme);
        };

        // --- LOCAL STORAGE & SCHEDULE DATA ---
        const saveSchedule = () => {
            localStorage.setItem('classBuddySchedule', JSON.stringify(schedule));
            renderSchedule();
            if (currentView === 'day') {
                renderTimelineView();
            }
        };

        const loadSchedule = () => {
            const savedSchedule = localStorage.getItem('classBuddySchedule');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
            } else {
                // Rebuilt schedule with class blocks and flipped classroom data
                schedule = {
                    Monday: [
                        { start: '08:15', end: '09:45', subject: 'à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸¨à¸²à¸ªà¸•à¸£à¹Œ(7)', isFlipped: true },
                        { start: '09:50', end: '16:00', subject: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸œà¸¹à¹‰à¹€à¸£à¸µà¸¢à¸™' },
                    ],
                    Tuesday: [
                        { start: '07:45', end: '08:15', subject: 'Homeroom'},
                        { start: '08:15', end: '09:00', subject: 'à¸ªà¸¸à¸‚à¸¨à¸¶à¸à¸©à¸²7' },
                        { start: '09:00', end: '09:45', subject: 'à¸žà¸¥à¸¨à¸¶à¸à¸©à¸²7' },
                        { start: '09:50', end: '11:20', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸ªà¸·à¹ˆà¸­à¸¡à¸±à¸¥à¸•à¸´à¸¡à¸µà¹€à¸”à¸µà¸¢' },
                        { start: '12:55', end: '14:25', subject: 'à¸­à¸±à¸‡à¸à¸¤à¸©à¸Ÿà¸±à¸‡-à¸žà¸¹à¸”à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£ 1' },
                        { start: '14:30', end: '16:00', subject: 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸© 7' },
                    ],
                    Wednesday: [
                        { start: '08:15', end: '09:45', subject: 'à¸à¸²à¸£à¸‡à¸²à¸™à¸­à¸²à¸Šà¸µà¸ž(4) (à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ)', isFlipped: true },
                        { start: '09:50', end: '11:20', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ 7' },
                        { start: '12:55', end: '14:25', subject: 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œà¸à¸²à¸¢à¸ à¸²à¸ž 1' },
                        { start: '14:30', end: '16:00', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1' },
                    ],
                    Thursday: [
                        { start: '08:15', end: '09:45', subject: 'à¸¨à¸´à¸¥à¸›à¸° 7 (à¸”à¸™à¸•à¸£à¸µ)', isFlipped: true },
                        { start: '09:50', end: '11:20', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)' },
                        { start: '12:55', end: '13:40', subject: 'à¸à¸´à¸ˆà¸à¸£à¸£à¸¡à¸žà¸±à¸’à¸™à¸²à¸„à¸§à¸²à¸¡à¸„à¸´à¸”à¹à¸¥à¸°à¸ˆà¸´à¸•à¹ƒà¸ˆ' },
                        { start: '13:40', end: '16:00', subject: 'à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸à¸²à¸£à¹€à¸‚à¸µà¸¢à¸™à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ' },
                    ],
                    Friday: [
                        { start: '08:15', end: '09:45', subject: 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ 7' },
                        { start: '09:50', end: '11:20', subject: 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸² à¸¨à¸²à¸ªà¸™à¸²à¹à¸¥à¸°à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡ 7' },
                        { start: '12:55', end: '14:25', subject: 'à¸à¸²à¸£à¸­à¸­à¸à¹à¸šà¸šà¸à¸£à¸²à¸Ÿà¸´à¸à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œ 1' },
                        { start: '14:30', end: '16:00', subject: 'à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œà¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡(1)' },
                    ],
                    Saturday: [], 
                    Sunday: [],
                };
                saveSchedule();
            }
        };

        // --- RENDER FUNCTIONS ---
        const renderSchedule = () => {
            scheduleGrid.innerHTML = '';
            DAYS_OF_WEEK.filter(day => day !== 'Sunday' && day !== 'Saturday').forEach(day => {
                const dayClasses = schedule[day] || [];
                dayClasses.sort((a, b) => a.start.localeCompare(b.start));
                const card = document.createElement('div');
                card.className = 'schedule-card p-6 rounded-2xl';
                let classesHtml = `<p class="text-secondary">No classes scheduled.</p>`;
                if (dayClasses.length > 0) {
                    classesHtml = dayClasses.map(cls => {
                        const subjectDisplay = `
                            <div class="flex items-center">
                                <span class="font-medium text-primary">${cls.subject}</span>
                                ${cls.isFlipped ? `<span class="badge ml-2 text-xs font-semibold px-2 py-0.5 rounded-full">Flipped</span>` : ''}
                            </div>
                        `;
                        
                        return `
                            <div class="flex justify-between items-center py-2 border-b last:border-b-0" style="border-color: rgba(var(--border-color-rgb, 209, 209, 214), 0.2)">
                                ${subjectDisplay}
                                <span class="text-sm bg-alt text-primary font-medium px-2.5 py-1 rounded-md whitespace-nowrap">${cls.start} - ${cls.end}</span>
                            </div>
                        `;
                    }).join('');
                }
                card.innerHTML = `<h3 class="font-bold text-xl text-primary mb-4">${day}</h3><div class="space-y-1">${classesHtml}</div>`;
                scheduleGrid.appendChild(card);
            });
        };
        
        const updateScrollHint = () => {
            if (!timelineView) return;
            // Use requestAnimationFrame to ensure layout is calculated
            requestAnimationFrame(() => {
                const isScrollable = timelineView.scrollWidth > timelineView.clientWidth;
                timelineView.classList.toggle('is-scrollable', isScrollable);
            });
        };

        const renderTimelineView = () => {
            const todayName = DAYS_OF_WEEK[new Date().getDay()];
            const todaySchedule = (schedule[todayName] || []).filter(c => c.start && c.end).sort((a,b) => a.start.localeCompare(b.start));
            timelineView.innerHTML = '';

            if (todaySchedule.length === 0) {
                timelineView.innerHTML = `<p class="text-secondary text-center py-8">No classes scheduled for today. Enjoy your day! ðŸŽ‰</p>`;
                updateScrollHint();
                return;
            }

            const timeToMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };

            const startHour = Math.floor(timeToMinutes(todaySchedule[0].start) / 60);
            const endHour = Math.ceil(timeToMinutes(todaySchedule[todaySchedule.length - 1].end) / 60);
            const timelineStartMinutes = startHour * 60;
            const timelineEndMinutes = endHour * 60;
            const totalDuration = timelineEndMinutes - timelineStartMinutes;
            
            const container = document.createElement('div');
            container.className = 'timeline-container';
            container.style.minWidth = `${(endHour - startHour) * 70}px`; // Give more space for readability

            // Create hour labels and grid
            const hoursWrapper = document.createElement('div');
            hoursWrapper.className = 'timeline-hours';
            const gridWrapper = document.createElement('div');
            gridWrapper.className = 'timeline-grid';

            for (let i = startHour; i <= endHour; i++) {
                const hourLabel = document.createElement('span');
                hourLabel.textContent = `${i % 12 === 0 ? 12 : i % 12}${i < 12 ? 'am' : 'pm'}`;
                hoursWrapper.appendChild(hourLabel);
                const gridLine = document.createElement('div');
                gridLine.className = 'timeline-grid-line';
                gridWrapper.appendChild(gridLine);
            }
            
            container.appendChild(hoursWrapper);
            container.appendChild(gridWrapper);

            // Create class blocks
            todaySchedule.forEach(cls => {
                const startMinutes = timeToMinutes(cls.start);
                const endMinutes = timeToMinutes(cls.end);

                const left = ((startMinutes - timelineStartMinutes) / totalDuration) * 100;
                const width = ((endMinutes - startMinutes) / totalDuration) * 100;
                
                if (width <= 0) return;

                const block = document.createElement('div');
                block.className = 'timeline-class-block';
                block.style.left = `${left}%`;
                block.style.width = `${width}%`;
                block.title = `${cls.subject} (${cls.start} - ${cls.end})`;

                block.innerHTML = `
                    <span class="timeline-class-subject truncate">${cls.subject}</span>
                    <span class="text-xs opacity-80">${cls.start} - ${cls.end}</span>
                `;
                container.appendChild(block);
            });
            
            // Create time indicator
            const timeIndicator = document.createElement('div');
            timeIndicator.id = 'time-indicator';
            timeIndicator.className = 'timeline-time-indicator';
            container.appendChild(timeIndicator);

            timelineView.appendChild(container);

            updateTimeIndicator();
            updateScrollHint();
        };

        const updateTimeIndicator = () => {
            const indicator = document.getElementById('time-indicator');
            if (!indicator || currentView !== 'day') return;

            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            const todayName = DAYS_OF_WEEK[now.getDay()];
            const todaySchedule = (schedule[todayName] || []).filter(c => c.start && c.end).sort((a,b) => a.start.localeCompare(b.start));
            if (todaySchedule.length === 0) return;

            const timeToMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };

            const startHour = Math.floor(timeToMinutes(todaySchedule[0].start) / 60);
            const endHour = Math.ceil(timeToMinutes(todaySchedule[todaySchedule.length - 1].end) / 60);
            const timelineStartMinutes = startHour * 60;
            const timelineEndMinutes = endHour * 60;
            const totalDuration = timelineEndMinutes - timelineStartMinutes;

            if (nowMinutes >= timelineStartMinutes && nowMinutes <= timelineEndMinutes) {
                const left = ((nowMinutes - timelineStartMinutes) / totalDuration) * 100;
                indicator.style.left = `${left}%`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        };
        
        const switchView = (view) => {
            currentView = view;

            if (view === 'week') {
                weekViewBtn.classList.add('active');
                dayViewBtn.classList.remove('active');
                scheduleGrid.classList.remove('hidden');
                timelineView.classList.add('hidden');
                if (timeIndicatorInterval) clearInterval(timeIndicatorInterval);
                timeIndicatorInterval = null;
            } else {
                weekViewBtn.classList.remove('active');
                dayViewBtn.classList.add('active');
                scheduleGrid.classList.add('hidden');
                timelineView.classList.remove('hidden');
                renderTimelineView();
                if (timeIndicatorInterval) clearInterval(timeIndicatorInterval);
                timeIndicatorInterval = setInterval(updateTimeIndicator, 60000); // Update every minute
            }
        };

        const addChatBubble = (message, sender) => {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble p-3 rounded-2xl mb-2 max-w-xs sm:max-w-md break-words';
            if (sender === 'user') {
                bubble.classList.add('bg-accent', 'text-on-accent', 'ml-auto');
            } else {
                bubble.classList.add('bg-alt', 'text-primary', 'mr-auto');
            }
            bubble.innerHTML = message;
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return bubble;
        };

        const renderSuggestions = (suggestions) => {
            if (!chatSuggestionsContainer) return;
            chatSuggestionsContainer.innerHTML = '';
            if (suggestions.length === 0) return;
        
            suggestions.forEach(suggestion => {
                const pill = document.createElement('button');
                pill.className = 'suggestion-pill';
                pill.type = 'button'; // Prevent default form submission
                pill.textContent = suggestion;
                pill.addEventListener('click', () => {
                    questionInput.value = suggestion;
                    qaForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                    chatSuggestionsContainer.innerHTML = ''; // Hide after click
                });
                chatSuggestionsContainer.appendChild(pill);
            });
        };
        
        // --- EDIT FORM FUNCTIONS ---
        const renderEditForm = () => {
            if (!scheduleInputsContainer) return;
            scheduleInputsContainer.innerHTML = '';
        
            DAYS_OF_WEEK.filter(day => day !== 'Sunday' && day !== 'Saturday').forEach(day => {
                const dayContainer = document.createElement('div');
                dayContainer.className = 'mb-6 p-4 rounded-lg border border-default';
                dayContainer.innerHTML = `<h4 class="text-lg font-bold text-primary mb-3">${day}</h4>`;
        
                const classesContainer = document.createElement('div');
                classesContainer.className = 'space-y-3';
                
                (schedule[day] || []).forEach((session, index) => {
                    const classRow = document.createElement('div');
                    classRow.className = 'edit-class-row'; // Use the new grid-based class
        
                    classRow.innerHTML = `
                        <div class="edit-class-row-time">
                            <input type="time" data-day="${day}" data-index="${index}" data-field="start" value="${session.start}" class="form-input w-full">
                            <span class="text-secondary hidden sm:inline">-</span>
                            <input type="time" data-day="${day}" data-index="${index}" data-field="end" value="${session.end}" class="form-input w-full">
                        </div>
                        <div class="edit-class-row-subject">
                            <input type="text" placeholder="Subject Name" data-day="${day}" data-index="${index}" data-field="subject" value="${session.subject}" class="form-input w-full">
                        </div>
                        <div class="edit-class-row-controls">
                            <label class="flex items-center cursor-pointer" title="Mark as Flipped Classroom">
                                <span class="text-sm text-secondary mr-2">Flipped</span>
                                <div class="relative">
                                    <input type="checkbox" data-day="${day}" data-index="${index}" data-field="isFlipped" class="sr-only peer" ${session.isFlipped ? 'checked' : ''}>
                                    <div class="toggle-bg block w-11 h-6 rounded-full peer-checked:bg-accent"></div>
                                    <div class="toggle-dot absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full peer-checked:translate-x-full"></div>
                                </div>
                            </label>
                            <button data-day="${day}" data-index="${index}" data-action="remove" class="remove-btn" aria-label="Remove class">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                    classesContainer.appendChild(classRow);
                });
                
                dayContainer.appendChild(classesContainer);
        
                const addButton = document.createElement('button');
                addButton.dataset.day = day;
                addButton.dataset.action = 'add';
                addButton.className = 'add-class-day-btn mt-4';
                addButton.textContent = `+ Add Class to ${day}`;
                dayContainer.appendChild(addButton);
        
                scheduleInputsContainer.appendChild(dayContainer);
            });
        };

        const handleScheduleEdit = (e) => {
            const target = e.target;
            const interactiveElement = target.closest('[data-day]');
            if (!interactiveElement) return;

            const { day, index, field, action } = interactiveElement.dataset;
        
            // Handle button clicks (add/remove)
            if (action) {
                const daySchedule = schedule[day] || [];
                if (action === 'remove' && index) {
                    daySchedule.splice(parseInt(index, 10), 1);
                } else if (action === 'add') {
                    daySchedule.push({ start: '09:00', end: '10:00', subject: 'New Class', isFlipped: false });
                }
                schedule[day] = daySchedule;
                saveSchedule();
                renderEditForm(); // Re-render to reflect changes
                return;
            }

            // Handle input changes (time, subject, flipped)
            if (field && day && index) {
                const session = schedule[day]?.[parseInt(index, 10)];
                if(session) {
                    const inputElement = target;
                    session[field] = inputElement.type === 'checkbox' ? inputElement.checked : inputElement.value;
                    saveSchedule(); // Save on every input change
                }
            }
        };

        const toggleEditForm = () => {
            const isHidden = editScheduleForm.classList.toggle('hidden');
            if (!isHidden) {
                switchView('week'); // Force week view for editing
                renderEditForm();
                editScheduleToggleBtn.textContent = 'Done';
                editScheduleToggleBtn.classList.add('bg-accent', 'text-on-accent', 'border-transparent');
            } else {
                editScheduleToggleBtn.textContent = 'Edit';
                editScheduleToggleBtn.classList.remove('bg-accent', 'text-on-accent', 'border-transparent');
            }
        };
        
        // --- OFFLINE Q&A LOGIC (BILINGUAL) ---
        const processQuestionOffline = (query) => {
            const lowerQuery = query.toLowerCase().trim().replace(/[?.,]/g, '');
            const isThaiQuery = THAI_REGEX.test(lowerQuery);
            const now = new Date();
            const todayName = DAYS_OF_WEEK[now.getDay()];
            const nowTime = now.toTimeString().substring(0, 5);
            
            const getResponse = (eng, thai) => isThaiQuery ? thai : eng;

            // --- NLP HELPER FUNCTIONS ---
            const extractTimeContext = () => {
                for (const [keyword, context] of Object.entries(TIME_CONTEXT_MAP)) {
                    if (lowerQuery.includes(keyword)) return context;
                }
                return null;
            };

            const extractDay = () => {
                for (const [keyword, day] of Object.entries(DAY_KEYWORD_MAP)) {
                    if (lowerQuery.includes(keyword)) {
                        if (day === 'today') return todayName;
                        if (day === 'tomorrow') return DAYS_OF_WEEK[(now.getDay() + 1) % 7];
                        if (day === 'yesterday') return DAYS_OF_WEEK[(now.getDay() + 6) % 7];
                        return day;
                    }
                }
                return null;
            };
        
            const extractSubject = () => {
                for (const [keyword, subject] of Object.entries(SUBJECT_KEYWORD_MAP)) {
                    if (lowerQuery.includes(keyword)) return subject;
                }
                return null;
            };

            const targetDay = extractDay();
            const targetSubject = extractSubject();
            const timeContext = extractTimeContext();
            const dayToQuery = targetDay || todayName;
            const dayDisplay = isThaiQuery ? ENG_TO_THAI_DAY_MAP[dayToQuery] : dayToQuery;
            
            let daySchedule = (schedule[dayToQuery] || []).slice().sort((a,b) => a.start.localeCompare(b.start));

            // Pre-filter schedule based on time context (morning, afternoon, etc.)
            if (timeContext) {
                daySchedule = daySchedule.filter(c => c.start >= timeContext.start && c.start < timeContext.end);
                if (daySchedule.length === 0) {
                    return getResponse(`You have no classes in the ${timeContext.eng} on ${dayToQuery}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${timeContext.thai}à¹ƒà¸™${dayDisplay}`);
                }
            }

            // --- INTENT HANDLING (SAME AS BEFORE) ---
            const casualResponses = {
                'skip|à¹‚à¸”à¸”|à¹‚à¸”à¸”à¹€à¸£à¸µà¸¢à¸™': getResponse(`I can't officially recommend that, but I can tell you what you'd be missing!`, `à¹„à¸¡à¹ˆà¹à¸™à¸°à¸™à¸³à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¸™à¸° à¹à¸•à¹ˆà¸šà¸­à¸à¹ƒà¸«à¹‰à¹„à¸”à¹‰à¸§à¹ˆà¸²à¸ˆà¸°à¸žà¸¥à¸²à¸”à¸­à¸°à¹„à¸£à¹„à¸›à¸šà¹‰à¸²à¸‡`),
                'survivable|pain|suffer|ruin|cry|à¸£à¸­à¸”à¹„à¸«à¸¡|à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢à¸¡à¸±à¹‰à¸¢': getResponse(`You've got this! Just take it one class at a time. Your first class today is **${(schedule[todayName] || [])[0]?.subject || 'nothing, you are free!'}**.`, `à¸ªà¸¹à¹‰à¹†! à¹€à¸”à¸µà¹‹à¸¢à¸§à¸à¹‡à¸«à¸¡à¸”à¸§à¸±à¸™à¹à¸¥à¹‰à¸§ à¸„à¹ˆà¸­à¸¢à¹† à¹„à¸›à¸—à¸µà¸¥à¸°à¸„à¸²à¸šà¸™à¸° à¸„à¸²à¸šà¹à¸£à¸à¸‚à¸­à¸‡à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸·à¸­ **${(schedule[todayName] || [])[0]?.subject || 'à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ à¸§à¹ˆà¸²à¸‡à¸ˆà¹‰à¸²!'}**`),
                'sleep|nap time|à¸‡à¹ˆà¸§à¸‡|à¸™à¸­à¸™': getResponse(`Your schedule says official nap time is after your last class! The last class today ends at **${daySchedule.slice().pop()?.end || 'N/A'}**.`, `à¹€à¸§à¸¥à¸²à¸™à¸­à¸™à¸«à¸¥à¸±à¸šà¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¸„à¸·à¸­à¸«à¸¥à¸±à¸‡à¸„à¸²à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸™à¸°! à¸§à¸±à¸™à¸™à¸µà¹‰à¸„à¸²à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¹€à¸¥à¸´à¸ **${daySchedule.slice().pop()?.end || 'à¹„à¸¡à¹ˆà¸¡à¸µ'}**`),
                'escape|go home|get out|leave|à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™': getResponse(`Freedom is scheduled for **${daySchedule.slice().pop()?.end || 'anytime you want'}** today, after **${daySchedule.slice().pop()?.subject || 'an empty schedule'}**.`, `à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™à¹„à¸”à¹‰à¸•à¸­à¸™ **${daySchedule.slice().pop()?.end || 'à¸§à¹ˆà¸²à¸‡à¹à¸¥à¹‰à¸§ à¸à¸¥à¸±à¸šà¹„à¸”à¹‰à¹€à¸¥à¸¢'}** à¸§à¸±à¸™à¸™à¸µà¹‰ à¸«à¸¥à¸±à¸‡à¹€à¸£à¸µà¸¢à¸™à¸§à¸´à¸Šà¸² **${daySchedule.slice().pop()?.subject || 'à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™'}** à¸ˆà¸š`),
                'fun|chill|boring|long one|à¸™à¹ˆà¸²à¹€à¸šà¸·à¹ˆà¸­|à¸¢à¸²à¸§à¸™à¸²à¸™': getResponse(`That's subjective, but I can show you the schedule and you can decide for yourself!`, `à¸­à¸±à¸™à¸™à¸µà¹‰à¹à¸¥à¹‰à¸§à¹à¸•à¹ˆà¸„à¸™à¹€à¸¥à¸¢ à¹€à¸”à¸µà¹‹à¸¢à¸§à¹€à¸›à¸´à¸”à¸•à¸²à¸£à¸²à¸‡à¹ƒà¸«à¹‰à¸”à¸¹ à¹à¸¥à¹‰à¸§à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹€à¸­à¸‡à¸™à¸°!`),
            };
            for (const [keywords, response] of Object.entries(casualResponses)) {
                if (keywords.split('|').some(k => lowerQuery.includes(k))) return response;
            }
            if (lowerQuery.includes('full schedule') || lowerQuery.includes('weekly schedule') || lowerQuery.includes('all week') || lowerQuery.includes('à¸—à¸±à¹‰à¸‡à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ') || lowerQuery.includes('à¸—à¸±à¹‰à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ')) {
                let fullScheduleStr = getResponse("Here's your full weekly schedule:", "à¸™à¸µà¹ˆà¸„à¸·à¸­à¸•à¸²à¸£à¸²à¸‡à¸ªà¸­à¸™à¸—à¸±à¹‰à¸‡à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œà¸‚à¸­à¸‡à¹€à¸˜à¸­:");
                for (const day of DAYS_OF_WEEK.slice(1, 6)) {
                    const classes = schedule[day] || [];
                    fullScheduleStr += `\n\n**${getResponse(day, ENG_TO_THAI_DAY_MAP[day])}**`;
                    if (classes.length === 0) {
                        fullScheduleStr += getResponse(`\n- No classes!`, `\n- à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™!`);
                    } else {
                        classes.forEach(c => {
                            fullScheduleStr += `\n- ${c.subject} (${c.start} - ${c.end})${c.isFlipped ? ' (Flipped)' : ''}`;
                        });
                    }
                }
                return fullScheduleStr;
            }
            const timeMatch = lowerQuery.match(/(\d{1,2})(?::(\d{2}))?(?:\s*(am|pm|à¹‚à¸¡à¸‡))?/);
            if (timeMatch && (lowerQuery.includes(' at ') || lowerQuery.includes('à¸•à¸­à¸™'))) {
                let hour = parseInt(timeMatch[1], 10);
                const minute = parseInt(timeMatch[2] || '0', 10);
                const period = timeMatch[3];
                if (period === 'pm' && hour < 12) hour += 12;
                if (period === 'am' && hour === 12) hour = 0;
                const queryTime = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                
                const classAtTime = daySchedule.find(c => queryTime >= c.start && queryTime < c.end);
                return classAtTime
                    ? getResponse(`At ${queryTime} on ${dayToQuery}, you have **${classAtTime.subject}**.`, `${dayDisplay} à¸•à¸­à¸™ ${queryTime} à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${classAtTime.subject}**`)
                    : getResponse(`You don't have any class scheduled at ${queryTime} on ${dayToQuery}.`, `${dayDisplay} à¸•à¸­à¸™ ${queryTime} à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸™à¸°`);
            }
            if (lowerQuery.includes('now') || lowerQuery.includes('à¸•à¸­à¸™à¸™à¸µà¹‰')) {
                if(dayToQuery !== todayName) return getResponse(`I can only tell you what's happening 'now' for today. For ${dayToQuery}, please ask about a specific time.`, `à¸šà¸­à¸à¹„à¸”à¹‰à¹à¸„à¹ˆà¸§à¹ˆà¸² 'à¸•à¸­à¸™à¸™à¸µà¹‰' à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸™à¸° à¸–à¹‰à¸²à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸§à¸±à¸™à¸­à¸·à¹ˆà¸™ à¹ƒà¸«à¹‰à¸–à¸²à¸¡à¹€à¸§à¸¥à¸²à¹€à¸ˆà¸²à¸°à¸ˆà¸‡à¸¡à¸²à¹€à¸¥à¸¢`);
                const currentClass = daySchedule.find(c => nowTime >= c.start && nowTime < c.end);
                if(currentClass) return getResponse(`You are currently in **${currentClass.subject}**, which ends at ${currentClass.end}.`, `à¸•à¸­à¸™à¸™à¸µà¹‰à¸à¸³à¸¥à¸±à¸‡à¹€à¸£à¸µà¸¢à¸™à¸§à¸´à¸Šà¸² **${currentClass.subject}** à¸­à¸¢à¸¹à¹ˆ à¹€à¸¥à¸´à¸à¸•à¸­à¸™ ${currentClass.end}`);
                const nextClass = daySchedule.find(c => c.start > nowTime);
                if(nextClass) return getResponse(`You're on a break. Your next class is **${nextClass.subject}** at ${nextClass.start}.`, `à¸•à¸­à¸™à¸™à¸µà¹‰à¸žà¸±à¸à¸­à¸¢à¸¹à¹ˆ à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¹€à¸£à¸µà¸¢à¸™ **${nextClass.subject}** à¸•à¸­à¸™ ${nextClass.start}`);
                return getResponse(`You're done for today! No more classes scheduled right now.`, `à¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸£à¸µà¸¢à¸™à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§! à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸²à¸šà¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¹‰à¸§à¸ˆà¹‰à¸²`);
            }
            if ((lowerQuery.includes('next') || lowerQuery.includes('à¸–à¸±à¸”à¹„à¸›') || lowerQuery.includes('à¸•à¹ˆà¸­à¹„à¸›')) && !targetSubject) {
                if(dayToQuery !== todayName) return getResponse(`I can only tell you the 'next' class for today.`, `à¸šà¸­à¸ 'à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›' à¹„à¸”à¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸±à¸™à¸™à¸µà¹‰à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸™à¸°`);
                const nextClass = daySchedule.find(c => c.start > nowTime);
                return nextClass ? getResponse(`Your next class is **${nextClass.subject}** at ${nextClass.start}.`, `à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¸„à¸·à¸­ **${nextClass.subject}** à¸•à¸­à¸™ ${nextClass.start}`) : getResponse(`You have no more classes scheduled for today.`, `à¸§à¸±à¸™à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¹à¸¥à¹‰à¸§`);
            }
            const timeContextString = timeContext ? getResponse(` in the ${timeContext.eng}`, `à¹ƒà¸™${timeContext.thai}`) : '';
            if (lowerQuery.includes('first') || lowerQuery.includes('à¹à¸£à¸')) return daySchedule.length > 0 ? getResponse(`Your first class${timeContextString} on ${dayToQuery} is **${daySchedule[0].subject}** at ${daySchedule[0].start}.`, `à¸„à¸²à¸šà¹à¸£à¸${timeContextString}à¸‚à¸­à¸‡${dayDisplay}à¸„à¸·à¸­ **${daySchedule[0].subject}** à¸•à¸­à¸™ ${daySchedule[0].start}`) : getResponse(`You have no classes${timeContextString} on ${dayToQuery}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${timeContextString}à¹ƒà¸™${dayDisplay}`);
            if (lowerQuery.includes('last') || lowerQuery.includes('à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢')) return daySchedule.length > 0 ? getResponse(`Your last class${timeContextString} on ${dayToQuery} is **${daySchedule[daySchedule.length-1].subject}**, ending at ${daySchedule[daySchedule.length-1].end}.`, `à¸„à¸²à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢${timeContextString}à¸‚à¸­à¸‡${dayDisplay}à¸„à¸·à¸­ **${daySchedule[daySchedule.length-1].subject}** à¹€à¸¥à¸´à¸à¸•à¸­à¸™ ${daySchedule[daySchedule.length-1].end}`) : getResponse(`You have no classes${timeContextString} on ${dayToQuery}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${timeContextString}à¹ƒà¸™${dayDisplay}`);
            if (targetSubject && (lowerQuery.includes('after') || lowerQuery.includes('à¸«à¸¥à¸±à¸‡') || lowerQuery.includes('à¸•à¹ˆà¸­à¸ˆà¸²à¸'))) {
                const classIndex = daySchedule.findIndex(c => c.subject === targetSubject);
                if (classIndex === -1) return getResponse(`I couldn't find **${targetSubject}** on ${dayToQuery}.`, `à¸«à¸² **${targetSubject}** à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¸‚à¸­à¸‡${dayDisplay}à¹„à¸¡à¹ˆà¹€à¸ˆà¸­`);
                if (classIndex >= daySchedule.length - 1) return getResponse(`**${targetSubject}** is your last class on ${dayToQuery}.`, `**${targetSubject}** à¹€à¸›à¹‡à¸™à¸„à¸²à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸‚à¸­à¸‡${dayDisplay}à¹à¸¥à¹‰à¸§`);
                const nextClass = daySchedule[classIndex + 1];
                return getResponse(`After **${targetSubject}**, you have **${nextClass.subject}** at ${nextClass.start}.`, `à¸«à¸¥à¸±à¸‡à¸§à¸´à¸Šà¸² **${targetSubject}** à¸à¹‡à¸ˆà¸°à¹€à¸›à¹‡à¸™ **${nextClass.subject}** à¸•à¸­à¸™ ${nextClass.start}`);
            }
            if (lowerQuery.includes('how many') || lowerQuery.includes('à¸à¸µà¹ˆà¸§à¸´à¸Šà¸²') || lowerQuery.includes('à¸à¸µà¹ˆà¸„à¸²à¸š')) {
                return getResponse(`You have **${daySchedule.length}** class blocks${timeContextString} on ${dayToQuery}.`, `à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${daySchedule.length}** à¸„à¸²à¸š${timeContextString}à¹ƒà¸™${dayDisplay}`);
            }
            if (targetSubject && (lowerQuery.includes('how long') || lowerQuery.includes('à¸™à¸²à¸™à¹à¸„à¹ˆà¹„à¸«à¸™') || lowerQuery.includes('à¸™à¸²à¸™à¸¡à¸±à¹‰à¸¢'))) {
                const classInfo = daySchedule.find(c => c.subject === targetSubject);
                if (!classInfo) return getResponse(`I couldn't find **${targetSubject}** on ${dayToQuery}.`, `à¸«à¸² **${targetSubject}** à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¸‚à¸­à¸‡${dayDisplay}à¹„à¸¡à¹ˆà¹€à¸ˆà¸­`);
                const start = new Date(`1970-01-01T${classInfo.start}`);
                const end = new Date(`1970-01-01T${classInfo.end}`);
                const duration = (end.getTime() - start.getTime()) / 60000; // in minutes
                return getResponse(`**${targetSubject}** on ${dayToQuery} is **${duration} minutes** long.`, `à¸§à¸´à¸Šà¸² **${targetSubject}** à¹ƒà¸™${dayDisplay}à¹€à¸£à¸µà¸¢à¸™à¸™à¸²à¸™ **${duration} à¸™à¸²à¸—à¸µ**`);
            }
            if (targetSubject) {
                const classesOnDay = daySchedule.filter(c => c.subject === targetSubject);
                if (classesOnDay.length > 0) {
                    const times = classesOnDay.map(c => `${c.start} - ${c.end}`).join(' and ');
                    return getResponse(`Yes, you have **${targetSubject}** on ${dayToQuery} from ${times}.`, `à¹ƒà¸Šà¹ˆ à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${targetSubject}** à¹ƒà¸™${dayDisplay} à¸•à¸­à¸™ ${times}`);
                }
                if (targetDay) {
                    return getResponse(`Nope, you do not have **${targetSubject}** on ${dayToQuery}.`, `à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${targetSubject}** à¹ƒà¸™${dayDisplay}`);
                }

                const weeklyOccurrences = [];
                let dayIndex = now.getDay();
                for(let i=0; i < 7; i++) {
                    const searchDay = DAYS_OF_WEEK[(dayIndex + i) % 7];
                    (schedule[searchDay] || []).forEach(c => {
                        if (c.subject === targetSubject) {
                            if (searchDay === todayName && c.start < nowTime && (lowerQuery.includes('next') || lowerQuery.includes('à¸•à¹ˆà¸­à¹„à¸›') || lowerQuery.includes('à¸–à¸±à¸”à¹„à¸›'))) {
                                return;
                            }
                            weeklyOccurrences.push({ day: searchDay, time: c.start });
                        }
                    });
                }

                if(weeklyOccurrences.length > 0) {
                    const firstOccurrence = weeklyOccurrences[0];
                    const nextClassString = getResponse(`on ${firstOccurrence.day} at ${firstOccurrence.time}`, `${ENG_TO_THAI_DAY_MAP[firstOccurrence.day]} à¸•à¸­à¸™ ${firstOccurrence.time}`);
                    if (lowerQuery.includes('next') || lowerQuery.includes('à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­à¹„à¸›') || lowerQuery.includes('à¸–à¸±à¸”à¹„à¸›') || lowerQuery.includes('à¸•à¹ˆà¸­à¹„à¸›')) {
                        return getResponse(`Your next **${targetSubject}** is ${nextClassString}.`, `à¸„à¸²à¸š **${targetSubject}** à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­à¹„à¸›à¸„à¸·à¸­ ${nextClassString}`);
                    }
                    const allOccurrences = weeklyOccurrences.map(o => getResponse(`${o.day} at ${o.time}`, `${ENG_TO_THAI_DAY_MAP[o.day]} à¸•à¸­à¸™ ${o.time}`)).join(', ');
                    return getResponse(`You have **${targetSubject}** on: ${allOccurrences}.`, `à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™ **${targetSubject}** à¹ƒà¸™à¸§à¸±à¸™/à¹€à¸§à¸¥à¸²: ${allOccurrences}`);
                }
                return getResponse(`I can't find **${targetSubject}** anywhere in your weekly schedule.`, `à¸«à¸² **${targetSubject}** à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡à¸ªà¸­à¸™à¹„à¸¡à¹ˆà¹€à¸ˆà¸­à¹€à¸¥à¸¢`);
            }
            if (targetDay) {
                if (daySchedule.length === 0) return getResponse(`You have no classes scheduled for ${targetDay}. Enjoy your free day! ðŸŽ‰`, `${dayDisplay}à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸™à¸° à¸žà¸±à¸à¸œà¹ˆà¸­à¸™à¹„à¸”à¹‰à¹€à¸¥à¸¢! ðŸŽ‰`);
                const classList = daySchedule.map(c => `\n- **${c.subject}** (${c.start} - ${c.end})`).join('');
                return getResponse(`On ${targetDay}, your schedule is:${classList}`, `à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™${dayDisplay}à¸„à¸·à¸­:${classList}`);
            }

            return getResponse(
                "Sorry, I couldn't understand that. You can ask for a day's schedule (e.g., 'What's on Monday?'), ask about a class (e.g., 'Do I have Math today?'), or ask 'what's next?'.",
                "à¸‚à¸­à¹‚à¸—à¸©à¸™à¸° à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸—à¸µà¹ˆà¸–à¸²à¸¡à¹€à¸¥à¸¢ à¸¥à¸­à¸‡à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™à¸”à¸¹à¸ªà¸´ à¹€à¸Šà¹ˆà¸™ 'à¸§à¸±à¸™à¸ˆà¸±à¸™à¸—à¸£à¹Œà¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£?', 'à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™à¸„à¸“à¸´à¸•à¹„à¸«à¸¡?', à¸«à¸£à¸·à¸­ 'à¸„à¸²à¸šà¸•à¹ˆà¸­à¹„à¸›à¹€à¸£à¸µà¸¢à¸™à¸­à¸°à¹„à¸£?'"
            );
        };


        const handleQuestion = (question) => {
            const answer = processQuestionOffline(question);
            return answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        };

        // --- EVENT HANDLERS ---
        const updateSuggestions = () => {
            const query = questionInput.value.trim();
            const lowerQuery = query.toLowerCase();
        
            if (query === '') {
                renderSuggestions(CHAT_SUGGESTIONS);
                return;
            }
        
            const suggestionsSet = new Set();
            const isThaiQuery = THAI_REGEX.test(lowerQuery);
        
            // 1. Detect keywords from input
            const detectedSubjects = new Set();
            Object.entries(SUBJECT_KEYWORD_MAP).forEach(([keyword, subject]) => {
                if (lowerQuery.includes(keyword.toLowerCase())) {
                    detectedSubjects.add(subject);
                }
            });
        
            const detectedDayKeywords = new Set();
            Object.entries(DAY_KEYWORD_MAP).forEach(([keyword, day]) => {
                if (lowerQuery.includes(keyword)) {
                    detectedDayKeywords.add(keyword);
                }
            });
        
            const detectedTimeKeywords = new Set();
            Object.entries(TIME_CONTEXT_MAP).forEach(([keyword, context]) => {
                if (lowerQuery.includes(keyword)) {
                    detectedTimeKeywords.add(isThaiQuery ? context.thai : context.eng);
                }
            });
        
            // 2. Generate dynamic suggestions based on detected keywords
            if (detectedSubjects.size > 0) {
                detectedSubjects.forEach(subject => {
                    const keywords = REVERSE_SUBJECT_KEYWORD_MAP[subject];
                    if (!keywords) return;
                    const engKeyword = keywords.eng.find(k => k.length > 2) || keywords.eng[0] || subject;
                    const thaiKeyword = keywords.thai[0] || subject;
        
                    if (detectedDayKeywords.size > 0 || detectedTimeKeywords.size > 0) {
                        const context = [...detectedDayKeywords, ...detectedTimeKeywords].join(' ');
                        suggestionsSet.add(`What time is ${engKeyword} ${context}?`);
                        suggestionsSet.add(`à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${thaiKeyword}${context}à¹„à¸«à¸¡`);
                    } else {
                        suggestionsSet.add(`Do I have ${engKeyword} today?`);
                        suggestionsSet.add(`When is the next ${engKeyword} class?`);
                        suggestionsSet.add(`à¸žà¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰à¸¡à¸µà¹€à¸£à¸µà¸¢à¸™${thaiKeyword}à¹„à¸«à¸¡`);
                    }
                });
            } else if (detectedDayKeywords.size > 0) {
                detectedDayKeywords.forEach(keyword => {
                    const day = DAY_KEYWORD_MAP[keyword];
                    const dayDisplayEng = day === 'today' ? 'today' : day.charAt(0).toUpperCase() + day.slice(1);
                    const dayDisplayThai = day === 'today' ? 'à¸§à¸±à¸™à¸™à¸µà¹‰' : ENG_TO_THAI_DAY_MAP[dayDisplayEng] || keyword;
                    suggestionsSet.add(`What is on ${dayDisplayEng}?`);
                    suggestionsSet.add(`à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™${dayDisplayThai}`);
                });
            } else if (detectedTimeKeywords.size > 0) {
                detectedTimeKeywords.forEach(time => {
                    suggestionsSet.add(`What's my schedule this ${time}?`);
                    suggestionsSet.add(`à¸•à¸²à¸£à¸²à¸‡à¹€à¸£à¸µà¸¢à¸™${isThaiQuery ? `à¸Šà¹ˆà¸§à¸‡${time}`: time}`);
                });
            }
        
            // 3. Add filtered static suggestions and merge
            const filteredStatic = CHAT_SUGGESTIONS.filter(s => s.toLowerCase().includes(lowerQuery));
            filteredStatic.forEach(s => suggestionsSet.add(s));

            // Fallback to defaults if nothing generated
            if (suggestionsSet.size === 0 && query.length > 2) {
                renderSuggestions([]);
            } else if (suggestionsSet.size > 0) {
                renderSuggestions(Array.from(suggestionsSet).slice(0, 6));
            } else {
                renderSuggestions(CHAT_SUGGESTIONS);
            }
        };
        

        qaForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;
            addChatBubble(question, 'user');
            questionInput.value = '';
            renderSuggestions([]); // Clear suggestions on submit
            
            const answer = handleQuestion(question);
            addChatBubble(answer.replace(/\n/g, '<br>'), 'bot');
        });

        themeToggleBtn.addEventListener('click', toggleTheme);
        weekViewBtn.addEventListener('click', () => switchView('week'));
        dayViewBtn.addEventListener('click', () => switchView('day'));


        // --- INITIALIZATION ---
        const init = () => {
            // Theme initialization
            const savedTheme = localStorage.getItem('classBuddyTheme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));

            // Add styles for the edit form
            const style = document.createElement('style');
            style.id = 'edit-form-styles';
            style.textContent = `
                .form-input { background-color: var(--bg-alt); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 0.5rem 0.75rem; color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
                .form-input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 2px var(--accent-primary); }
                .remove-btn { color: var(--text-secondary); padding: 0.5rem; border-radius: 9999px; transition: background-color 0.2s, color 0.2s; }
                .remove-btn:hover { background-color: #ef4444; color: white; }
                .add-class-day-btn { width: 100%; background-color: rgba(var(--accent-rgb), 0.1); color: var(--accent-primary); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; }
                .add-class-day-btn:hover { background-color: rgba(var(--accent-rgb), 0.2); }
            `;
            document.head.appendChild(style);

            editScheduleToggleBtn.addEventListener('click', toggleEditForm);
            scheduleInputsContainer.addEventListener('input', handleScheduleEdit);
            scheduleInputsContainer.addEventListener('click', handleScheduleEdit);
            addClassBtn.style.display = 'none'; // Hide the old global add button

            // Suggestions logic
            questionInput.addEventListener('focus', updateSuggestions);
            questionInput.addEventListener('input', updateSuggestions);
            document.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.closest('#qa-form') && !target.closest('#chat-suggestions-container')) {
                    if (chatSuggestionsContainer) chatSuggestionsContainer.innerHTML = '';
                }
            });

            // Listen for resize to update scroll hint
            window.addEventListener('resize', updateScrollHint);
            
            loadSchedule();
            renderSchedule();

            // Proactive welcome message
            const todayName = DAYS_OF_WEEK[new Date().getDay()];
            const todaySchedule = (schedule[todayName] || []).filter(c => c.start).sort((a,b) => a.start.localeCompare(b.start));
            let welcomeMessage = "Hello! I'm ClassBuddy. Ask me anything about your schedule.";
            if (todaySchedule.length > 0) {
                welcomeMessage = `Hello! I'm ClassBuddy. Today you have ${todaySchedule.length} class(es), starting with <strong>${todaySchedule[0].subject}</strong> at ${todaySchedule[0].start}. What can I help you with?`;
            } else if (todayName !== 'Saturday' && todayName !== 'Sunday') {
                welcomeMessage = `Hello! I'm ClassBuddy. It looks like you have no classes scheduled for today. Enjoy your day off! ðŸŽ‰`;
            }
            addChatBubble(welcomeMessage, 'bot');
            
            // Dynamic year in footer
            const yearEl = document.getElementById('current-year');
            if (yearEl) yearEl.textContent = new Date().getFullYear().toString();
        };

        init();
    });
</script>
</body>
</html>
